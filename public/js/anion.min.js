"use strict";var AniONUtils={parseDate:function(a){return a.indexOf("999999")>-1||a.indexOf("000")>-1?moment(null):moment(a,"YYYYMMDD")},parseDate2:function(a){return a.indexOf("999999")>-1||a.indexOf("000")>-1?moment(null):moment(a,"YYYYMMDD YYYYMM YYYY".split(" "))},formatDate:function(a){return"string"==typeof a&&(a=AniONUtils.parseDate2(a)),moment.isMoment(a)&&a.isValid()?a.format({YYYYMMDD:"YYYY/MM/DD",YYYYMM:"YYYY/MM",YYYY:"YYYY/??"}[a._f]):"???"},formatDate2:function(a){return"string"==typeof a&&(a=AniONUtils.parseDate2(a)),moment.isMoment(a)&&a.isValid()?a.format({YYYYMMDD:"YYYY년 M월 DD일",YYYYMM:"YYYY년 M월",YYYY:"YYYY년?"}[a._f]):"???"},formatTime:function(a){var b=moment(a,"HHmm");return b.isValid()?b.format("A h:mm"):"???"},makeItem:function(a,b){var c=moment().format("YYYYMMDD"),d={id:a.id,weekday:a.weekday,title:a.title,title2:a.title,genre:a.genre,time:a.time,ended:a.ended,homepage:a.homepage,state:"",startdate:a.startdate,enddate:a.enddate,amode:b.amode,query:b.query,genre_query:b.genre,comingsoon:!1,completed:!1,absent:!1},e=AniONUtils.parseDate(a.startdate),f=AniONUtils.parseDate(a.enddate);d.weekday<7&&(e.isValid()&&c<a.startdate&&(d.comingsoon=e.format("ll"),"d"!==b.amode&&(d.state="["+e.format("MM/DD")+"]",d.comingsoon=!0)),f.isValid()&&c>=a.enddate&&!a.ended&&(d.state="(완결)",d.completed=!0),a.ended||a.broaded||(d.state="(결방)",d.absent=!0)),d.notice=/anissia\.net/.test(a.homepage);var g=a.title,h="극장판,OVA,OAD,미방영화,()";return g=g.replace(/제?\d+기/,""),h.split(",").forEach(function(a){g=g.replace(a,"")}),d.title2=g.trim(),d},escapeRegexp:function(a){return a.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},reorderAnis:function(a){var b=[],c=[],d=[];a.forEach(function(a){var e=b;a.comingsoon?e=d:a.completed&&(e=c),e.push(a)});var e=b.concat(d,c);return e}};angular.module("AniONFilters",[]).filter({weekday1:function(){return function(a){return null===a?"종":"일월화수목금토외신"[a]}},weekday:function(){return function(a){return null===a?"종영":"일요일 월요일 화요일 수요일 목요일 금요일 토요일 기타 신작".split(" ")[a]}},time4:function(){return AniONUtils.formatTime},date8:function(){return AniONUtils.formatDate},date8_2:function(){return AniONUtils.formatDate2},startdate:function(){return function(a){var b=AniONUtils.parseDate2(a);return b.format("YYYY년 MM월")+" 방영"}},datetime14:function(){return function(a){var b=moment(a,"YYYYMMDDHHmmss");return b.isValid()?b.format("YYYY/MM/DD A h:mm"):"???"}},genre:function(){return function(a){return a?a.replace(/,/g,", "):"장르 불명"}},highlight:["$sce",function(a){return function(b){return a.trustAsHtml(b.replace(/``(.+?)``/g,'<span class="match">$1</span>'))}}],matchQuery:function(){return function(a,b){if(!b)return a;var c=new RegExp("("+AniONUtils.escapeRegexp(b)+")","gi");return a.replace(c,"``$1``")}},urlhost:function(){return function(a){var b=document.createElement("a");b.href=a;var c=b.hostname;return c.length>25&&(c=c.substr(0,25)+"…"),c}},escapeHtml:function(){var a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return function(b){return String(b).replace(/[&<>"'\/]/g,function(b){return a[b]})}}});var AniON=angular.module("AniON",["ngRoute","ngTouch","MainCtrlers"]);AniON.config(["$routeProvider",function(a){a.when("/",{template:document.getElementById("T-anilist").innerHTML,controller:"AniListCtrler"}).when("/ani/:id",{template:document.getElementById("T-anidetail").innerHTML,controller:"AniDetailCtrler",resolve:{aniDetail:["$route","AniDetailFactory",function(a,b){var c=a.current.params.id;return b.getAniDetail(c)}]}}).otherwise({redirectTo:"/"})}]).run(["$location","AniListFactory",function(a,b){var c=a.path();""!==c&&"/"!==c||b.getTodayAniList()}]),AniON.factory("AniListFactory",["$rootScope","$http",function(a,b){var c,d,e;return{anis:[],recent:{},getRecentAniList:function(){this.broadcastAniList(this.recent)},getAniList:function(d,e){var f=this;return d===-1?d=c:c=d,"undefined"==typeof e&&(e=1),a.$broadcast("beforeAniList"),b.get("api/anilist/?weekday="+d+"&page="+e).success(function(a){f.anis=a.result,f.broadcastAniList({amode:"w",weekday:d,count:a.count,page:e})})},getTodayAniList:function(){var a=(new Date).getDay();return this.getAniList(a)},searchAniList:function(c,e){var f=this;return c===-1?c=d:d=c,"undefined"==typeof e&&(e=1),a.$broadcast("beforeAniList"),b.get("api/anilist/?search="+encodeURIComponent(c)+"&page="+e).success(function(a){f.anis=a.result,f.broadcastAniList({amode:"s",query:c,count:a.count,page:e})})},getByGenreAniList:function(c,d){var f=this;return c===-1?c=e:e=c,"undefined"==typeof d&&(d=1),a.$broadcast("beforeAniList"),b.get("api/anilist/?genre="+encodeURIComponent(c)+"&page="+d).success(function(a){f.anis=a.result,f.broadcastAniList({amode:"g",genre:c,count:a.count,page:d})})},broadcastAniList:function(b){this.recent=b,a.$broadcast("gotAniList",b)},getAniGenres:function(){return b.get("api/genres").success(function(b){a.$broadcast("gotAniGenres",b.sort())})}}}]),AniON.factory("AniDetailFactory",["$rootScope","$http",function(a,b){return{getAniDetail:function(c){return a.$broadcast("beforeAniDetail"),b({method:"GET",url:"api/ani",params:{id:c},cache:!0}).success(function(b){return a.$broadcast("gotAniDetail",b),b})}}}]),AniON.factory("AniCaptionFactory",["$rootScope","$http","$q",function(a,b,c){return{getCaptions:function(a){return b({method:"GET",url:"api/cap",params:{id:a},cache:!0})}}}]),AniON.controller("TitlebarCtrler",["$scope","$location","$window","AniListFactory",function(a,b,c,d){a.formdata={},a.menuVisible=!1,a.currentWeekday=null,a.aniGenres=[],a.goBack=function(a){a.preventDefault(),a.stopPropagation(),c.history.back()},a.toggleMenu=function(b){b.preventDefault(),b.stopPropagation(),a.menuVisible=!a.menuVisible,0===a.aniGenres.length&&d.getAniGenres()},a.$on("gotAniList",function(b,c){a.menuVisible=!1;var d=c.amode;"g"!==d&&(a.selectedGenre=""),"w"===d?a.currentWeekday=c.weekday:"s"!==d&&"g"!==d||(a.currentWeekday=null)}),a.$on("gotAniGenres",function(b,c){0===a.aniGenres.length&&(a.aniGenres=c)}),a.showWeekday=function(a,c){b.path("/"),d.getAniList(c,1),window.scrollTo(0,0)},a.searchAniList=function(c){b.path("/"),d.searchAniList(a.formdata.query),window.scrollTo(0,0),document.activeElement.blur()},a.showByGenres=function(){document.activeElement.blur(),b.path("/");var c=a.selectedGenre;""!==c?d.getByGenreAniList(c,1):d.getTodayAniList()}}]),AniON.controller("MainViewCtrler",["$scope","$rootScope",function(a,b){a.loading=!0,a.currentWeekday=null,a.$on("beforeAniList",function(b){a.loading=!0}),a.$on("beforeAniDetail",function(b){a.loading=!0}),a.$on("gotAniList",function(c,d){a.loading=!1,"w"===d.amode?(b.title="Ani-ON",a.currentWeekday=d.weekday):(a.currentWeekday=null,"s"===d.amode&&(b.title='"'+d.query+'"에 대한 검색 결과 – Ani-ON'))}),a.$on("gotAniDetail",function(c,d){a.loading=!1,b.title=d.title+" – Ani-ON"})}]);var MainCtrlers=angular.module("MainCtrlers",["AniONFilters"]);MainCtrlers.controller("AniListCtrler",["$scope","AniListFactory",function(a,b){a.init=function(){b.getRecentAniList()},a.$on("gotAniList",function(c,d){b.anis.length>0?a.anis=AniONUtils.reorderAnis(b.anis.map(function(a){return AniONUtils.makeItem(a,d)})):a.anis=[],document.getElementById("main").className="main-ani-list"}),a.swipeLeft=function(c){var d=a.currentWeekday;null!==d&&d<=6&&b.getAniList(d<6?d+1:0)},a.swipeRight=function(c){var d=a.currentWeekday;null!==d&&d<=6&&b.getAniList(d>0?d-1:6)}}]),MainCtrlers.controller("AniListPageCtrler",["$scope","AniListFactory",function(a,b){a.init=function(){b.getRecentAniList()},a.$on("gotAniList",function(b,c){var d=c.count;a.current_page=c.page,a.current_listmode=c.amode,a.pages=[];for(var e=1;e<=Math.ceil(d/30);e++)a.pages.push(e)}),a.showPage=function(c,d){var e;switch(a.current_listmode){case"w":e="getAniList";break;case"s":e="searchAniList";break;case"g":e="getByGenreAniList"}b[e](-1,d),window.scrollTo(0,0)}}]),MainCtrlers.directive("aniItem",["AniCaptionFactory",function(a){return{restrict:"E",scope:!0,controller:["$scope",function(a){a.expanded=!1,a.expand=function(b,c){b.preventDefault(),a.expanded=!a.expanded}}],template:document.getElementById("T-aniitem").innerHTML}}]),MainCtrlers.directive("capList",["$window","AniCaptionFactory",function(a,b){return{restrict:"E",scope:{aniID:"=aniid"},controller:["$scope",function(c){c.caps=[],c.caps_loading=!0,c.aniID&&b.getCaptions(c.aniID).success(function(a){c.caps_loading=!1,c.caps=a}),c.checklink=function(b,c){b.preventDefault(),c?a.open(c,"_blank"):alert("주소가 등록되어있지 않습니다.")}}],template:document.getElementById("T-caplist").innerHTML}}]),MainCtrlers.controller("AniDetailCtrler",["$scope","$routeParams","$window","aniDetail",function(a,b,c,d){a.ani=AniONUtils.makeItem(d.data,{amode:"d"}),a.$on("$routeChangeSuccess",function(b){document.getElementById("main").className="main-ani-detail",a.loading=!1})}]);